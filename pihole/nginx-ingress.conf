server {
    listen 8099 default_server;

    # Internally rewrite root to /admin/ (no browser redirect)
    location = / {
        rewrite ^ /admin/ last;
    }

    location / {
        proxy_pass http://127.0.0.1:80;
        proxy_set_header Host 127.0.0.1;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable compression so sub_filter can work
        proxy_set_header Accept-Encoding "";

        # Rewrite FTL redirect Location headers to include ingress path
        proxy_redirect ~^https?://[^/]+/(.*) $http_x_ingress_path/$1;
        proxy_redirect /admin/ $http_x_ingress_path/admin/;
        proxy_redirect /api/ $http_x_ingress_path/api/;

        # Allow iframe embedding for HA ingress
        proxy_hide_header X-Frame-Options;

        # Rewrite absolute paths in responses to include ingress prefix
        sub_filter_once off;
        sub_filter_types text/html text/css application/javascript application/json;
        sub_filter '"/admin' '"$http_x_ingress_path/admin';
        sub_filter "'/admin" "'$http_x_ingress_path/admin";
        sub_filter '"/api' '"$http_x_ingress_path/api';
        sub_filter "'/api" "'$http_x_ingress_path/api";
    }
}
